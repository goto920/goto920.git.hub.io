(this["webpackJsonpfiltering-player"]=this["webpackJsonpfiltering-player"]||[]).push([[0],{16:function(e,t,a){e.exports=a(27)},21:function(e,t,a){},22:function(e,t,a){},27:function(e,t,a){"use strict";a.r(t);var i=a(0),r=a.n(i),n=a(9),s=a.n(n),l=(a(21),a(3)),o=a(4),h=a(1),c=a(15),u=a(14),f=(a(22),a(5)),p=a(6),d=a(10),m=a(11),v=a(13),g=a(12),y=a(2),b=a.n(y),F=function(){function e(t,a,i){Object(l.a)(this,e),this.audioCtx=t,this.shiftSize=a,this.sampleRate=i.sampleRate,this.rfft=new g.FFTR(2*this.shiftSize),this.fftObjBuffer=[],this.lastInput=[],this.lastInput[0]=new Float32Array(a).fill(0),this.lastInput[1]=new Float32Array(a).fill(0),this.lastOut=[],this.lastOut[0]=new Float32Array(a).fill(0),this.lastOut[1]=new Float32Array(a).fill(0),this.filterChain=[],this.calcFFT=this.calcFFT.bind(this),this.justFFT=this.justFFT.bind(this),this.calcPan=this.calcPan.bind(this),this.calcPerc=this.calcPerc.bind(this),this.fftFilter=this.fftFilter.bind(this),this.addFilter=this.addFilter.bind(this),this.clearAllFilter=this.clearAllFilter.bind(this),this.presetFilter=this.presetFilter.bind(this)}return Object(o.a)(e,[{key:"addFilter",value:function(e,t,a,i,r){var n=Math.min(this.shiftSize,Math.round(this.shiftSize*(2*t/this.sampleRate))),s=Math.min(this.shiftSize,Math.round(this.shiftSize*(2*i/this.sampleRate)));this.filterChain.push({fromPan:e,fromFreqIndex:n,toPan:a,toFreqIndex:s,action:r})}},{key:"clearAllFilter",value:function(){this.filterChain.length=0}},{key:"copy",value:function(e,t){for(var a=0;a<e.numberOfChannels;a++){var i=e.getChannelData(a),r=t.getChannelData(a);if(AudioBuffer.prototype.copyToChannel)t.copyToChannel(i,a,0);else for(var n=0;n<e.length;n++)r[n]=i[n]}}},{key:"presetFilter",value:function(e,t){var a;switch(this.clearAllFilter(),console.log("filter, option ",e,t),e){case"bypass":break;case"drumCover":a=t,this.addFilter(-1,0,1,3e4,"H"),this.addFilter(-a/2,220,a/2,4e3,"T"),this.addFilter(-1,220,-.9,4e3,"T"),this.addFilter(.9,220,1,4e3,"T");break;case"karaokeMale":a=t,this.addFilter(-a/2,220,a/2,8e3,"M");break;case"karaokeFemale":a=t,this.addFilter(-a/2,350,a/2,8e3,"M");break;case"percussive":this.addFilter(-1,0,1,3e4,"P");break;case"harmonic":this.addFilter(-1,0,1,3e4,"H")}}},{key:"process",value:function(e,t){if(2===e.numberOfChannels){var a=[];a[0]=new Float32Array(2*this.shiftSize),a[1]=new Float32Array(2*this.shiftSize);for(var i=0;i<=1;i++){for(var r=e.getChannelData(i),n=0;n<2*this.shiftSize;n++)n<this.shiftSize?a[i][n]=this.lastInput[i][n]:n<this.shiftSize+r.length?a[i][n]=r[n-this.shiftSize]:a[i][n]=0;for(var s=0;s<this.shiftSize;s++)this.lastInput[i][s]=a[i][this.shiftSize+s]}var l=this.calcFFT(a),o=[];if(null!==l){var h=this.fftFilter(l);o[0]=this.rfft.inverse(h[0]).slice(),o[1]=this.rfft.inverse(h[1]).slice()}else o[0]=new Float32Array(2*this.shiftSize+2).fill(0),o[1]=new Float32Array(2*this.shiftSize+2).fill(0);for(var c=0;c<=1;c++){for(var u=t.getChannelData(c),f=0;f<this.shiftSize;f++)u[f]=this.lastOut[c][f]+o[c][f]/(2*this.shiftSize);for(var p=0;p<this.shiftSize;p++)this.lastOut[c][p]=o[c][this.shiftSize+p]/(2*this.shiftSize)}}}},{key:"justFFT",value:function(e){var t=[];return t[0]=this.rfft.forward(b.a.hann(e[0])).slice(),t[1]=this.rfft.forward(b.a.hann(e[1])).slice(),t}},{key:"calcFFT",value:function(e){var t=[];t[0]=this.rfft.forward(b.a.hann(e[0])).slice(),t[1]=this.rfft.forward(b.a.hann(e[1])).slice();var a=[];a[0]=new Float32Array(this.shiftSize+1),a[1]=new Float32Array(this.shiftSize+1);for(var i=0;i<=this.shiftSize;i++)a[0][i]=t[0][2*i]*t[0][2*i]+t[0][2*i+1]*t[0][2*i+1],a[1][i]=t[1][2*i]*t[1][2*i]+t[1][2*i+1]*t[1][2*i+1];var r={fftCoef:t,pan:[],panAmp:[],power:a,percL:[],percR:[]};return this.calcPan(r),this.fftObjBuffer.push(r),this.calcPerc(this.fftObjBuffer)}},{key:"calcPan",value:function(e){for(var t=e.fftCoef,a=t[0].length/2,i=new Float32Array(a),r=new Float32Array(a),n=0;n<a;n++){var s=2*n,l=t[0][s]*t[1][s]+t[0][s+1]*t[1][s+1],o=t[0][s]*t[1][s+1]-t[0][s+1]*t[1][s],h=Math.sqrt(Math.pow(t[0][s]+t[1][s],2)+Math.pow(t[0][s+1]+t[1][s+1],2)),c=Math.sqrt(Math.pow(t[0][s],2)+Math.pow(t[0][s+1],2)),u=Math.sqrt(Math.pow(t[1][s],2)+Math.pow(t[1][s+1],2)),f=Math.sqrt(Math.pow(t[0][s]-t[1][s],2)+Math.pow(t[0][s+1]-t[1][s+1],2)),p=0;c<u?(l<0?(p=0,r[n]=(f-c)/h):l<=u*u?(p=l/(u*u),r[n]=Math.max(c,f)-Math.abs(o)/u):(p=1,r[n]=c-f),i[n]=(1-p)/(1+p)):(l<0?(p=0,r[n]=(f-u)/h):l<=c*c?(p=l/(c*c),r[n]=Math.max(u,f)-Math.abs(o)/c):(p=1,r[n]=u-f),i[n]=(p-1)/(1+p)),isNaN(i[n])&&(i[n]=0),isNaN(r[n])&&(r[n]=0)}e.pan=i,e.panAmp=r}},{key:"calcPerc",value:function(e){var t=function(e){var t=Math.floor(e.length/2),a=Object(v.a)(e).sort((function(e,t){return e-t}));return e.length%2!==0?a[t]:(a[t-1]+a[t])/2},a=e.length;if(a<17)return null;for(var i=new Float32Array(this.shiftSize+1).fill(.5),r=new Float32Array(this.shiftSize+1).fill(.5),n=e[8],s=0;s<=this.shiftSize;s++){for(var l=Math.max(0,s-9),o=Math.min(s+9,this.shiftSize+1),h=t(n.power[0].slice(l,o)),c=t(n.power[1].slice(l,o)),u=[],f=[],p=0;p<a;p++)u.push(e[p].power[0][s]),f.length=0,f.push(e[p].power[1][s]);var d=t(u),m=t(f);i[s]=h*h/(h*h+d*d),isNaN(i[s])&&(i[s]=.5),r[s]=c*c/(c*c+m*m),isNaN(r[s])&&(r[s]=.5)}e[8].percL=i,e[8].percR=r;var g={fftCoef:[n.fftCoef[0].slice(),n.fftCoef[1].slice()],pan:n.pan.slice(),panAmp:n.panAmp.slice(),power:[n.power[0].slice(),n.power[1].slice()],perc:[i.slice(),r.slice()]};return a>=17&&e.splice(0,1),g}},{key:"fftFilter",value:function(e){for(var t=e.fftCoef[0],a=e.fftCoef[1],i=e.perc[0],r=e.perc[1],n=t.slice(),s=a.slice(),l=0;l<this.filterChain.length;l++)for(var o=this.filterChain[l],h=o.action,c=o.fromFreqIndex;c<=o.toFreqIndex;c++)if(!(e.pan[c]<o.fromPan||e.pan[c]>o.toPan))switch(h){case"T":n[2*c]=t[2*c],n[2*c+1]=t[2*c+1],s[2*c]=a[2*c],s[2*c+1]=a[2*c+1];break;case"M":n[2*c]=n[2*c+1]=0,s[2*c]=s[2*c+1]=0;break;case"P":n[2*c]=t[2*c]*i[c],n[2*c+1]=t[2*c+1]*i[c],s[2*c]=a[2*c]*r[c],s[2*c+1]=a[2*c+1]*r[c];break;case"H":n[2*c]=t[2*c]*(1-i[c]),n[2*c+1]=t[2*c+1]*(1-i[c]),s[2*c]=a[2*c]*(1-r[c]),s[2*c+1]=a[2*c+1]*(1-r[c]);break;default:console.log("Filter undef action",h)}return[n,s]}}]),e}(),S=(f.homepage+f.subversion).slice(-11),w=p.ja,k=p.us,A=k;window.AudioContext=window.AudioContext||window.webkitAudioContext;var C=null,E=null,P=null,j=!1;(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i))&&(j=!0);var M=function(e){Object(c.a)(a,e);var t=Object(u.a)(a);function a(e){var i;return Object(l.a)(this,a),(i=t.call(this,e)).params={inputAudio:null,filename:null,currentSource:null,isPlaying:!1,effectNode:null,fftShift:512,filterType:"bypass",vocalWidth:.2},i.counter=0,i.state={ja:!1,playingAt:0,playVolume:80,startButtonStr:"loadFile!"},i.loadFile=i.loadFile.bind(Object(h.a)(i)),i.handleLang=i.handleLang.bind(Object(h.a)(i)),i.handleTimeSlider=i.handleTimeSlider.bind(Object(h.a)(i)),i.handleVolumeSlider=i.handleVolumeSlider.bind(Object(h.a)(i)),i.handlePlay=i.handlePlay.bind(Object(h.a)(i)),i.handleSave=i.handleSave.bind(Object(h.a)(i)),i.selectFilter=i.selectFilter.bind(Object(h.a)(i)),i.fakeDownload=i.fakeDownload.bind(Object(h.a)(i)),i}return Object(o.a)(a,[{key:"handleWindowClose",value:function(e){C.close()}},{key:"componentDidMount",value:function(){C=new window.AudioContext,E=C.createGain(),window.addEventListener("beforeClosing",this.handleWindowClose)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("beforeClosing",this.handleWindowClose)}},{key:"render",value:function(){var e=0;this.params.inputAudio&&(e=this.params.inputAudio.duration);var t={};return"Pause"===this.state.startButtonStr&&(t={color:"green"}),r.a.createElement("div",{className:"App"},A.title,r.a.createElement("span",{className:"small-button"}," \xa0\xa0",r.a.createElement("button",{name:"language",onClick:this.handleLang},this.state.ja?"En(US)":"\u65e5\u672c\u8a9e")),r.a.createElement("hr",null),"Select stereo audio file (from local strage or cloud)",r.a.createElement("br",null),r.a.createElement("span",{className:"selectFile"},r.a.createElement("input",{type:"file",name:"loadFile",accept:"audio/*",onChange:this.loadFile}),r.a.createElement("br",null)),r.a.createElement("hr",null),r.a.createElement("span",{className:"selector"},"Filter: \xa0",r.a.createElement("select",{name:"selectFilter",defaultValue:"bypass",onChange:this.selectFilter},r.a.createElement("option",{value:"bypass"},"bypass"),r.a.createElement("option",{value:"drumCover"},"drumCover"),r.a.createElement("option",{value:"karaokeMale"},"karaokeMale"),r.a.createElement("option",{value:"karaokeFemale"},"karaokeFemale"),r.a.createElement("option",{value:"percussive"},"percussive"),r.a.createElement("option",{value:"harmonic"},"harmonic"),r.a.createElement("option",{value:"customWithGUI"},"customWithGUI")),"\xa0 vocalWidth: \xa0",r.a.createElement("select",{name:"vocalWidth",defaultValue:"0.2",onChange:this.selectFilter},r.a.createElement("option",{value:"0.1"},"0.1"),r.a.createElement("option",{value:"0.2"},"0.2"),r.a.createElement("option",{value:"0.3"},"0.3"),r.a.createElement("option",{value:"0.4"},"0.4"),r.a.createElement("option",{value:"0.5"},"0.5"),r.a.createElement("option",{value:"0.6"},"0.6"),r.a.createElement("option",{value:"0.7"},"0.7"))),r.a.createElement("hr",null),"Time: ",this.state.playingAt.toFixed(2)," ",r.a.createElement("br",null),r.a.createElement("span",{className:"slider"},r.a.createElement("center",null,"000 ",r.a.createElement("input",{type:"range",name:"timeSlider",min:"0",max:e,value:this.state.playingAt,step:"1",onChange:this.handleTimeSlider})," \xa0",Math.round(e),r.a.createElement("br",null))),r.a.createElement("hr",null),"Vol: ",this.state.playVolume," ",r.a.createElement("br",null),r.a.createElement("span",{className:"slider"},r.a.createElement("center",null,"000 ",r.a.createElement("input",{type:"range",name:"volumeSlider",min:"0",max:"150",value:this.state.playVolume,onChange:this.handleVolumeSlider})," 150",r.a.createElement("br",null))),r.a.createElement("hr",null),r.a.createElement("span",null,r.a.createElement("button",{name:"startPause",onClick:this.handlePlay,style:t},this.state.startButtonStr)," \xa0\xa0",r.a.createElement("button",{name:"rewind",onClick:this.handlePlay},"Rewind")),r.a.createElement("hr",null),"Version: ",S,", \xa0",r.a.createElement("a",{href:A.homepage,target:"_blank",rel:"noopener noreferrer"},A.guide))}},{key:"loadFile",value:function(e){if("loadFile"===e.target.name&&0!==e.target.files.length&&!this.params.isPlaying){var t=e.target.files[0];this.params.filename=t.name;var a=new FileReader;a.onload=function(e){C.decodeAudioData(a.result,function(e){this.params.inputAudio=e,this.setState({playingAt:0}),this.setState({startButtonStr:"Play"})}.bind(this),(function(e){console.log("Filereader error: "+e.err)}))}.bind(this),a.readAsArrayBuffer(t)}}},{key:"handleLang",value:function(e){"language"===e.target.name&&(this.state.ja?(A=k,this.setState({ja:!1})):(A=w,this.setState({ja:!0})))}},{key:"handleVolumeSlider",value:function(e){if("volumeSlider"===e.target.name){var t=parseInt(e.target.value);E.gain.value=t/100,this.setState({playVolume:t})}}},{key:"handleTimeSlider",value:function(e){this.params.isPlaying||"timeSlider"===e.target.name&&this.setState({playingAt:parseFloat(e.target.value)})}},{key:"handlePlay",value:function(e){var t=null;if("startPause"===e.target.name){if("Play"===this.state.startButtonStr){if(this.params.isPlaying||2!==this.params.inputAudio.numberOfChannels)return;if(this.params.isPlaying=!0,j){var a=C.createBuffer(1,1,44100);(t=C.createBufferSource()).buffer=a,t.connect(C.destination),t.start()}t=C.createBufferSource(),this.params.currentSource=t;for(var i,r=this.params.inputAudio,n=C.createBuffer(r.numberOfChannels,r.length+r.sampleRate,r.sampleRate),s=0;s<n.numberOfChannels;s++){for(var l=r.getChannelData(s),o=n.getChannelData(s),h=0;h<n.sampleRate/2;h++)o[h]=0;for(var c=n.sampleRate/2;c<r.length;c++)o[c]=l[c-n.sampleRate/2];for(var u=r.length;u<n.length;u++)o[u]=0}t.buffer=n,P=new F(C,this.params.fftShift,n);var f=this.params.inputAudio.numberOfChannels,p=this.params.fftShift;return C.createJavaScriptNode?(i=C.createJavaScriptNode(p,f,f),console.log("createJavaScriptNode")):C.createScriptProcessor&&(i=C.createScriptProcessor(p,f,f),console.log("createScriptProcessor")),this.params.effectNode=i,t.connect(i),i.connect(E),E.connect(C.destination),t.start(0,this.state.playingAt),i.onaudioprocess=function(e){var a=e.inputBuffer,r=e.outputBuffer;P.process(a,r),this.state.playingAt*a.sampleRate>=n.length&&(t.stop(),i.disconnect(),i.onaudioprocess=null,P=null),this.counter++;this.counter%20===0&&this.setState({playingAt:this.state.playingAt+20*a.length/a.sampleRate})}.bind(this),void this.setState({startButtonStr:"Pause"})}if("Pause"===this.state.startButtonStr){if(!this.params.isPlaying)return;return this.params.currentSource.disconnect(),this.params.effectNode.disconnect(),this.params.effectNode.onaudioprrocess=null,E.disconnect(),this.params.currentSource.stop(),this.setState({startButtonStr:"Play"}),void(this.params.isPlaying=!1)}}if("rewind"!==e.target.name);else{if(this.params.isPlaying)return;this.setState({playingAt:0})}}},{key:"selectFilter",value:function(e){if("selectFilter"===e.target.name&&null!==P){switch(e.target.value){case"drumCover":case"karaokeMale":case"karaokeFemale":P.presetFilter(e.target.value,this.params.vocalWidth);break;case"percussive":case"harmonic":P.presetFilter(e.target.value,0);break;case"bypass":case"customWithGUI":P.presetFilter("bypass",0)}this.params.filterType=e.target.value}"vocalWidth"===e.target.name&&null!==P&&null!==this.params.filterType&&(this.params.vocalWidth=parseFloat(e.target.value),P.presetFilter(this.params.filterType,this.params.vocalWidth))}},{key:"handleSave",value:function(e){}},{key:"fakeDownload",value:function(e){var t=this.params.filename.split(".")[0]+"&s"+parseInt(this.state.playSpeed)+"&p"+parseInt(100*this.state.playPitch)+".wav",a=new Blob([d(e)],{type:"audio/vnd.wav"});Object(m.saveAs)(a,t)}}]),a}(i.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(M,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},5:function(e){e.exports=JSON.parse('{"name":"filtering-player","version":"0.1.0","private":true,"homepage":"/demos/filtered-player/20200905","subversion":"-00","dependencies":{"@testing-library/jest-dom":"^5.11.4","@testing-library/react":"^10.4.9","@testing-library/user-event":"^12.1.3","audiobuffer-to-wav":"^1.0.0","fft-windowing":"^0.1.4","file-saver":"^2.0.2","kissfft-js":"^0.1.8","react":"^16.13.1","react-dom":"^16.13.1","react-scripts":"^3.4.3"},"scripts":{"start":"react-scripts start","build":"react-scripts build","test":"react-scripts test","eject":"react-scripts eject"},"eslintConfig":{"extends":"react-app"},"browserslist":{"production":[">0.2%","not dead","not op_mini all"],"development":["last 1 chrome version","last 1 firefox version","last 1 safari version"]}}')},6:function(e){e.exports=JSON.parse('{"us":{"title":"KG\'s Filtering Player","guide":"guide/update","homepage":"https://goto920.github.io/demos/filtering-player/"},"ja":{"title":"KG\'s \u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u30d7\u30ec\u30a4\u30e4\u30fc","guide":"\u30ac\u30a4\u30c9/\u66f4\u65b0","homepage":"https://goto920.github.io/demos/filtering-player/index-jp.html"}}')}},[[16,1,2]]]);
//# sourceMappingURL=main.04613f3c.chunk.js.map