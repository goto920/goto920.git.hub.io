(this["webpackJsonpfiltering-player"]=this["webpackJsonpfiltering-player"]||[]).push([[0],{16:function(e,t,a){e.exports=a(27)},21:function(e,t,a){},22:function(e,t,a){},27:function(e,t,a){"use strict";a.r(t);var i=a(0),n=a.n(i),r=a(9),s=a.n(r),l=(a(21),a(3)),o=a(4),h=a(1),c=a(15),u=a(14),f=(a(22),a(5)),p=a(6),d=a(10),m=a(11),v=a(13),g=a(12),b=a(2),y=a.n(b),S=function(){function e(t,a){Object(l.a)(this,e),this.shiftSize=t,this.sampleRate=a,this.rfft=new g.FFTR(2*this.shiftSize),this.fftObjBuffer=[],this.lastInput=[],this.lastInput[0]=new Float32Array(t).fill(0),this.lastInput[1]=new Float32Array(t).fill(0),this.lastOut=[],this.lastOut[0]=new Float32Array(t).fill(0),this.lastOut[1]=new Float32Array(t).fill(0),this.filterChain=[],this.calcFFT=this.calcFFT.bind(this),this.justFFT=this.justFFT.bind(this),this.calcPan=this.calcPan.bind(this),this.calcPerc=this.calcPerc.bind(this),this.fftFilter=this.fftFilter.bind(this),this.addFilter=this.addFilter.bind(this),this.clearAllFilter=this.clearAllFilter.bind(this),this.presetFilter=this.presetFilter.bind(this)}return Object(o.a)(e,[{key:"addFilter",value:function(e,t,a,i,n){var r=Math.min(this.shiftSize,Math.round(this.shiftSize*(2*t/this.sampleRate))),s=Math.min(this.shiftSize,Math.round(this.shiftSize*(2*i/this.sampleRate)));this.filterChain.push({fromPan:e,fromFreqIndex:r,toPan:a,toFreqIndex:s,action:n})}},{key:"clearAllFilter",value:function(){this.filterChain.length=0}},{key:"copy",value:function(e,t){for(var a=0;a<e.numberOfChannels;a++){var i=e.getChannelData(a),n=t.getChannelData(a);if(AudioBuffer.prototype.copyToChannel)t.copyToChannel(i,a,0);else for(var r=0;r<e.length;r++)n[r]=i[r]}}},{key:"presetFilter",value:function(e,t){var a;switch(this.clearAllFilter(),console.log("filter, option ",e,t),e){case"bypass":break;case"drumCover":a=t,this.addFilter(-1,0,1,3e4,"H"),this.addFilter(-a/2,220,a/2,4e3,"T"),this.addFilter(-1,220,-.9,4e3,"T"),this.addFilter(.9,220,1,4e3,"T");break;case"karaokeMale":a=t,this.addFilter(-a/2,220,a/2,8e3,"M");break;case"karaokeFemale":a=t,this.addFilter(-a/2,350,a/2,8e3,"M");break;case"percussive":this.addFilter(-1,0,1,3e4,"P");break;case"harmonic":this.addFilter(-1,0,1,3e4,"H")}}},{key:"process",value:function(e,t){if(2===e.numberOfChannels){var a=[];a[0]=new Float32Array(2*this.shiftSize),a[1]=new Float32Array(2*this.shiftSize);for(var i=0;i<=1;i++){for(var n=e.getChannelData(i),r=0;r<2*this.shiftSize;r++)r<this.shiftSize?a[i][r]=this.lastInput[i][r]:r<this.shiftSize+n.length?a[i][r]=n[r-this.shiftSize]:a[i][r]=0;for(var s=0;s<this.shiftSize;s++)this.lastInput[i][s]=a[i][this.shiftSize+s]}var l=this.calcFFT(a),o=[];if(null!==l){var h=this.fftFilter(l);o[0]=this.rfft.inverse(h[0]).slice(),o[1]=this.rfft.inverse(h[1]).slice()}else o[0]=new Float32Array(2*this.shiftSize+2).fill(0),o[1]=new Float32Array(2*this.shiftSize+2).fill(0);for(var c=0;c<=1;c++){for(var u=t.getChannelData(c),f=0;f<this.shiftSize;f++)u[f]=this.lastOut[c][f]+o[c][f]/(2*this.shiftSize);for(var p=0;p<this.shiftSize;p++)this.lastOut[c][p]=o[c][this.shiftSize+p]/(2*this.shiftSize)}}}},{key:"justFFT",value:function(e){var t=[];return t[0]=this.rfft.forward(y.a.hann(e[0])).slice(),t[1]=this.rfft.forward(y.a.hann(e[1])).slice(),t}},{key:"calcFFT",value:function(e){var t=[];t[0]=this.rfft.forward(y.a.hann(e[0])).slice(),t[1]=this.rfft.forward(y.a.hann(e[1])).slice();var a=[];a[0]=new Float32Array(this.shiftSize+1),a[1]=new Float32Array(this.shiftSize+1);for(var i=0;i<=this.shiftSize;i++)a[0][i]=t[0][2*i]*t[0][2*i]+t[0][2*i+1]*t[0][2*i+1],a[1][i]=t[1][2*i]*t[1][2*i]+t[1][2*i+1]*t[1][2*i+1];var n={fftCoef:t,pan:[],panAmp:[],power:a,percL:[],percR:[]};return this.calcPan(n),this.fftObjBuffer.push(n),this.calcPerc(this.fftObjBuffer)}},{key:"calcPan",value:function(e){for(var t=e.fftCoef,a=t[0].length/2,i=new Float32Array(a),n=new Float32Array(a),r=0;r<a;r++){var s=2*r,l=t[0][s]*t[1][s]+t[0][s+1]*t[1][s+1],o=t[0][s]*t[1][s+1]-t[0][s+1]*t[1][s],h=Math.sqrt(Math.pow(t[0][s]+t[1][s],2)+Math.pow(t[0][s+1]+t[1][s+1],2)),c=Math.sqrt(Math.pow(t[0][s],2)+Math.pow(t[0][s+1],2)),u=Math.sqrt(Math.pow(t[1][s],2)+Math.pow(t[1][s+1],2)),f=Math.sqrt(Math.pow(t[0][s]-t[1][s],2)+Math.pow(t[0][s+1]-t[1][s+1],2)),p=0;c<u?(l<0?(p=0,n[r]=(f-c)/h):l<=u*u?(p=l/(u*u),n[r]=Math.max(c,f)-Math.abs(o)/u):(p=1,n[r]=c-f),i[r]=(1-p)/(1+p)):(l<0?(p=0,n[r]=(f-u)/h):l<=c*c?(p=l/(c*c),n[r]=Math.max(u,f)-Math.abs(o)/c):(p=1,n[r]=u-f),i[r]=(p-1)/(1+p)),isNaN(i[r])&&(i[r]=0),isNaN(n[r])&&(n[r]=0)}e.pan=i,e.panAmp=n}},{key:"calcPerc",value:function(e){var t=function(e){var t=Math.floor(e.length/2),a=Object(v.a)(e).sort((function(e,t){return e-t}));return e.length%2!==0?a[t]:(a[t-1]+a[t])/2},a=e.length;if(a<17)return null;for(var i=new Float32Array(this.shiftSize+1).fill(.5),n=new Float32Array(this.shiftSize+1).fill(.5),r=e[8],s=0;s<=this.shiftSize;s++){for(var l=Math.max(0,s-9),o=Math.min(s+9,this.shiftSize+1),h=t(r.power[0].slice(l,o)),c=t(r.power[1].slice(l,o)),u=[],f=[],p=0;p<a;p++)u.push(e[p].power[0][s]),f.length=0,f.push(e[p].power[1][s]);var d=t(u),m=t(f);i[s]=h*h/(h*h+d*d),isNaN(i[s])&&(i[s]=.5),n[s]=c*c/(c*c+m*m),isNaN(n[s])&&(n[s]=.5)}e[8].percL=i,e[8].percR=n;var g={fftCoef:[r.fftCoef[0].slice(),r.fftCoef[1].slice()],pan:r.pan.slice(),panAmp:r.panAmp.slice(),power:[r.power[0].slice(),r.power[1].slice()],perc:[i.slice(),n.slice()]};return a>=17&&e.splice(0,1),g}},{key:"fftFilter",value:function(e){for(var t=e.fftCoef[0],a=e.fftCoef[1],i=e.perc[0],n=e.perc[1],r=t.slice(),s=a.slice(),l=0;l<this.filterChain.length;l++)for(var o=this.filterChain[l],h=o.action,c=o.fromFreqIndex;c<=o.toFreqIndex;c++)if(!(e.pan[c]<o.fromPan||e.pan[c]>o.toPan))switch(h){case"T":r[2*c]=t[2*c],r[2*c+1]=t[2*c+1],s[2*c]=a[2*c],s[2*c+1]=a[2*c+1];break;case"M":r[2*c]=r[2*c+1]=0,s[2*c]=s[2*c+1]=0;break;case"P":r[2*c]=t[2*c]*i[c],r[2*c+1]=t[2*c+1]*i[c],s[2*c]=a[2*c]*n[c],s[2*c+1]=a[2*c+1]*n[c];break;case"H":r[2*c]=t[2*c]*(1-i[c]),r[2*c+1]=t[2*c+1]*(1-i[c]),s[2*c]=a[2*c]*(1-n[c]),s[2*c+1]=a[2*c+1]*(1-n[c]);break;default:console.log("Filter undef action",h)}return[r,s]}}]),e}(),w=(f.homepage+f.subversion).slice(-11),F=p.ja,A=p.us,k=A;window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var C=null,E=null,P=null,O=!1;(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i))&&(O=!0);var j=function(e){Object(c.a)(a,e);var t=Object(u.a)(a);function a(e){var i;return Object(l.a)(this,a),(i=t.call(this,e)).params={inputAudio:null,outputAudio:null,filename:null,currentSource:null,isPlaying:!1,effectNode:null,fftShift:512,filterType:"bypass",vocalWidth:.2},i.counter=0,i.state={ja:!1,playingAt:0,playVolume:80,startButtonStr:"startPlay",testButtonStr:"test60sec",saveButtonStr:"Save"},i.loadFile=i.loadFile.bind(Object(h.a)(i)),i.handleLang=i.handleLang.bind(Object(h.a)(i)),i.handleTimeSlider=i.handleTimeSlider.bind(Object(h.a)(i)),i.handleVolumeSlider=i.handleVolumeSlider.bind(Object(h.a)(i)),i.handlePlay=i.handlePlay.bind(Object(h.a)(i)),i.handleOffline=i.handleOffline.bind(Object(h.a)(i)),i.handleSave=i.handleSave.bind(Object(h.a)(i)),i.selectFilter=i.selectFilter.bind(Object(h.a)(i)),i.fakeDownload=i.fakeDownload.bind(Object(h.a)(i)),i}return Object(o.a)(a,[{key:"handleWindowClose",value:function(e){C.close()}},{key:"componentDidMount",value:function(){C=new window.AudioContext,E=C.createGain(),window.addEventListener("beforeClosing",this.handleWindowClose)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("beforeClosing",this.handleWindowClose)}},{key:"render",value:function(){var e=0;this.params.inputAudio&&(e=this.params.inputAudio.duration);var t={};return"Pause"===this.state.startButtonStr&&(t={color:"green"}),n.a.createElement("div",{className:"App"},k.title,n.a.createElement("span",{className:"small-button"}," \xa0\xa0",n.a.createElement("button",{name:"language",onClick:this.handleLang},this.state.ja?"En(US)":"\u65e5\u672c\u8a9e")),n.a.createElement("hr",null),"Select stereo audio file (from local strage or cloud)",n.a.createElement("br",null),n.a.createElement("span",{className:"selectFile"},n.a.createElement("input",{type:"file",name:"loadFile",accept:"audio/*",onChange:this.loadFile}),n.a.createElement("br",null)),n.a.createElement("hr",null),n.a.createElement("span",{className:"selector"},"Filter: \xa0",n.a.createElement("select",{name:"selectFilter",defaultValue:"bypass",onChange:this.selectFilter},n.a.createElement("option",{value:"bypass"},"bypass"),n.a.createElement("option",{value:"drumCover"},"drumCover"),n.a.createElement("option",{value:"karaokeMale"},"karaokeMale"),n.a.createElement("option",{value:"karaokeFemale"},"karaokeFemale"),n.a.createElement("option",{value:"percussive"},"percussive"),n.a.createElement("option",{value:"harmonic"},"harmonic"),n.a.createElement("option",{value:"customWithGUI"},"customWithGUI")),"\xa0 vocalWidth: \xa0",n.a.createElement("select",{name:"vocalWidth",defaultValue:"0.2",onChange:this.selectFilter},n.a.createElement("option",{value:"0.1"},"0.1"),n.a.createElement("option",{value:"0.2"},"0.2"),n.a.createElement("option",{value:"0.3"},"0.3"),n.a.createElement("option",{value:"0.4"},"0.4"),n.a.createElement("option",{value:"0.5"},"0.5"),n.a.createElement("option",{value:"0.6"},"0.6"),n.a.createElement("option",{value:"0.7"},"0.7"))),n.a.createElement("hr",null),"Time: ",this.state.playingAt.toFixed(2)," ",n.a.createElement("br",null),n.a.createElement("span",{className:"slider"},n.a.createElement("center",null,"000 ",n.a.createElement("input",{type:"range",name:"timeSlider",min:"0",max:e,value:this.state.playingAt,step:"1",onChange:this.handleTimeSlider})," \xa0",Math.round(e),n.a.createElement("br",null))),n.a.createElement("hr",null),"Vol: ",this.state.playVolume," ",n.a.createElement("br",null),n.a.createElement("span",{className:"slider"},n.a.createElement("center",null,"000 ",n.a.createElement("input",{type:"range",name:"volumeSlider",min:"0",max:"150",value:this.state.playVolume,onChange:this.handleVolumeSlider})," 150",n.a.createElement("br",null))),n.a.createElement("hr",null),n.a.createElement("span",null,n.a.createElement("button",{name:"startPause",onClick:this.handlePlay,style:t},this.state.startButtonStr)," \xa0\xa0",n.a.createElement("button",{name:"rewind",onClick:this.handlePlay},"Rewind")," \xa0\xa0"),n.a.createElement("hr",null),n.a.createElement("span",null,n.a.createElement("button",{name:"testPlay",onClick:this.handleOffline},"testPlay")," \xa0\xa0",n.a.createElement("button",{name:"saveAll",onClick:this.handleOffline},this.state.saveButtonStr)),n.a.createElement("hr",null),"Version: ",w,", \xa0",n.a.createElement("a",{href:k.homepage,target:"_blank",rel:"noopener noreferrer"},k.guide))}},{key:"loadFile",value:function(e){if("loadFile"===e.target.name&&0!==e.target.files.length&&!this.params.isPlaying){var t=e.target.files[0];this.params.filename=t.name;var a=new FileReader;a.onload=function(e){C.decodeAudioData(a.result,function(e){this.params.inputAudio=e,this.setState({playingAt:0}),this.setState({startButtonStr:"Play"}),P=new S(this.params.fftShift,e.sampleRate)}.bind(this),(function(e){console.log("Filereader error: "+e.err)}))}.bind(this),a.readAsArrayBuffer(t)}}},{key:"handleLang",value:function(e){"language"===e.target.name&&(this.state.ja?(k=A,this.setState({ja:!1})):(k=F,this.setState({ja:!0})))}},{key:"handleVolumeSlider",value:function(e){if("volumeSlider"===e.target.name){var t=parseInt(e.target.value);E.gain.value=t/100,this.setState({playVolume:t})}}},{key:"handleTimeSlider",value:function(e){this.params.isPlaying||"timeSlider"===e.target.name&&this.setState({playingAt:parseFloat(e.target.value)})}},{key:"handlePlay",value:function(e){var t=null;if("startPause"===e.target.name){if("Play"===this.state.startButtonStr){if(this.params.isPlaying||2!==this.params.inputAudio.numberOfChannels)return;if(this.params.isPlaying=!0,O){var a=C.createBuffer(1,1,44100);(t=C.createBufferSource()).buffer=a,t.connect(C.destination),t.start()}t=C.createBufferSource(),this.params.currentSource=t;for(var i,n=this.params.inputAudio,r=C.createBuffer(n.numberOfChannels,n.length+n.sampleRate,n.sampleRate),s=0;s<r.numberOfChannels;s++){for(var l=n.getChannelData(s),o=r.getChannelData(s),h=0;h<r.sampleRate/2;h++)o[h]=0;for(var c=r.sampleRate/2;c<n.length;c++)o[c]=l[c-r.sampleRate/2];for(var u=n.length;u<r.length;u++)o[u]=0}t.buffer=r;var f=this.params.inputAudio.numberOfChannels,p=this.params.fftShift;return C.createJavaScriptNode?(i=C.createJavaScriptNode(p,f,f),console.log("createJavaScriptNode")):C.createScriptProcessor&&(i=C.createScriptProcessor(p,f,f),console.log("createScriptProcessor")),this.params.effectNode=i,t.connect(i),i.connect(E),E.connect(C.destination),t.start(0,this.state.playingAt),this.params.outputAudio=C.createBuffer(r.numberOfChannels,r.length,r.sampleRate),this.counter=0,i.onaudioprocess=function(e){var a=e.inputBuffer,n=e.outputBuffer;P.process(a,n);for(var s=n.getChannelData(0),l=n.getChannelData(1),o=this.params.outputAudio.getChannelData(0),h=this.params.outputAudio.getChannelData(1),c=0;c<this.params.fftShift;c++){var u=this.counter*this.params.fftShift;o[u+c]=s[c],h[u+c]=l[c]}if(this.state.playingAt*a.sampleRate>=r.length)return t.stop(),i.disconnect(),i.onaudioprocess=null,P=null,void this.fakeDownload(this.params.outputAudio);this.counter++;this.counter%20===0&&this.setState({playingAt:this.state.playingAt+20*a.length/a.sampleRate})}.bind(this),void this.setState({startButtonStr:"Pause"})}if("Pause"===this.state.startButtonStr){if(!this.params.isPlaying)return;return this.params.currentSource.disconnect(),this.params.effectNode.disconnect(),this.params.effectNode.onaudioprrocess=null,E.disconnect(),this.params.currentSource.stop(),this.setState({startButtonStr:"Play"}),void(this.params.isPlaying=!1)}}if("rewind"!==e.target.name);else{if(this.params.isPlaying)return;this.setState({playingAt:0})}}},{key:"selectFilter",value:function(e){if("selectFilter"===e.target.name&&null!==P){switch(e.target.value){case"drumCover":case"karaokeMale":case"karaokeFemale":P.presetFilter(e.target.value,this.params.vocalWidth);break;case"percussive":case"harmonic":P.presetFilter(e.target.value,0);break;case"bypass":case"customWithGUI":P.presetFilter("bypass",0)}this.params.filterType=e.target.value}"vocalWidth"===e.target.name&&null!==P&&null!==this.params.filterType&&(this.params.vocalWidth=parseFloat(e.target.value),P.presetFilter(this.params.filterType,this.params.vocalWidth))}},{key:"handleOffline",value:function(e){if("testPlay"===e.target.name){var t=new OfflineAudioContext(this.params.inputAudio.numberOfChannels,this.params.inputAudio.length,this.params.inputAudio.sampleRate),a=t.createBufferSource();a.buffer=this.params.inputAudio;var i=null;t.createJavaScriptNode?i=t.createJavaScriptNode(this.params.fftShift,2,0):t.createScriptProcessor&&(i=t.createScriptProcessor(this.params.fftShift,2,0)),this.params.effectNode=i,a.connect(i),i.connect(t.destination);var n=C.createBuffer(2,this.params.inputAudio.length,this.params.inputAudio.sampleRate),r=n.getChannelData(0),s=n.getChannelData(1),l=0;i.onaudioprocess=function(e){var t=e.inputBuffer,a=(t.getChannelData(0),t.getChannelData(1),C.createBuffer(2,t.length,t.sampleRate));P.process(t,a);for(var i=a.getChannelData(0),n=a.getChannelData(1),o=0;o<t.length;o++)r[l+o]=i[o],s[l+o]=n[o];l/this.params.fftShift%20===0&&this.setState({playingAt:l/t.sampleRate}),l+=this.params.fftShift}.bind(this),a.start(),t.startRendering(),t.oncomplete=function(e){var t=C.createBufferSource();t.buffer=n,t.connect(E),E.connect(C.destination),t.start()}.bind(this)}}},{key:"handleSave",value:function(e){null!==this.params.outputAudio&&this.fakeDownload(this.params.outputAudio)}},{key:"fakeDownload",value:function(e){var t=this.params.filename.split(".")[0]+"-modified.wav",a=new Blob([d(e)],{type:"audio/vnd.wav"});Object(m.saveAs)(a,t)}}]),a}(i.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(n.a.createElement(n.a.StrictMode,null,n.a.createElement(j,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},5:function(e){e.exports=JSON.parse('{"name":"filtering-player","version":"0.1.0","private":true,"homepage":"/demos/filtered-player/20200916","subversion":"-99","dependencies":{"@testing-library/jest-dom":"^5.11.4","@testing-library/react":"^10.4.9","@testing-library/user-event":"^12.1.4","audiobuffer-to-wav":"^1.0.0","fft-windowing":"^0.1.4","file-saver":"^2.0.2","kissfft-js":"^0.1.8","react":"^16.13.1","react-dom":"^16.13.1","react-scripts":"^3.4.3"},"scripts":{"start":"react-scripts start","build":"react-scripts build","test":"react-scripts test","eject":"react-scripts eject"},"eslintConfig":{"extends":"react-app"},"browserslist":{"production":[">0.2%","not dead","not op_mini all"],"development":["last 1 chrome version","last 1 firefox version","last 1 safari version"]}}')},6:function(e){e.exports=JSON.parse('{"us":{"title":"KG\'s Filtering Player","guide":"guide/update","homepage":"https://goto920.github.io/demos/filtering-player/"},"ja":{"title":"KG\'s \u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u30d7\u30ec\u30a4\u30e4\u30fc","guide":"\u30ac\u30a4\u30c9/\u66f4\u65b0","homepage":"https://goto920.github.io/demos/filtering-player/index-jp.html"}}')}},[[16,1,2]]]);
//# sourceMappingURL=main.48c15505.chunk.js.map